<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <title>Parallel Processing by Anderson-Lab</title>
    <link rel="stylesheet" href="stylesheets/styles.css">
    <link rel="stylesheet" href="stylesheets/github-dark.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>
    <script src="javascripts/main.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">

  </head>
  <body>

      <header>
        <h1>Parallel Processing</h1>
        <p>DATA 210 - Spring 2016</p>
      </header>

      <div id="banner">
        <span id="logo"></span>

        <a href="https://github.com/Anderson-Lab/parallel-processing" class="button fork"><strong>View On GitHub</strong></a>
        <div class="downloads">
          <span>Downloads:</span>
          <ul>
            <li><a href="https://github.com/Anderson-Lab/parallel-processing/zipball/master" class="button">ZIP</a></li>
            <li><a href="https://github.com/Anderson-Lab/parallel-processing/tarball/master" class="button">TAR</a></li>
          </ul>
        </div>
      </div><!-- end banner -->

    <div class="wrapper">
      <nav>
        <ul></ul>
      </nav>
      <section>
        <h1>
<a id="parallel-processing" class="anchor" href="#parallel-processing" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Parallel Processing</h1>

<p>In the real life, you may need to</p>

<ul>
<li>Scrape hundreds of web pages</li>
<li>Make dozens of API calls</li>
<li>Generate scatter plots for every pair of features</li>
</ul>

<p>If you know a programming language (scripting), this will work as well, but sometimes you want to just run a command line program multiple times, so it is a bit overkill. You can run things in sequential order or serial.</p>

<h2>
<a id="looping-over-numbers" class="anchor" href="#looping-over-numbers" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Looping over numbers</h2>

<div class="highlight highlight-source-shell"><pre><span class="pl-k">for</span> <span class="pl-smi">i</span> <span class="pl-k">in</span> {0..100..2}
<span class="pl-k">do</span>
    <span class="pl-c1">echo</span> <span class="pl-s"><span class="pl-pds">"</span><span class="pl-smi">$i</span>^2<span class="pl-pds">"</span></span> <span class="pl-k">|</span> bc
<span class="pl-k">done</span> <span class="pl-k">|</span> tail</pre></div>

<pre><code>6724
7056
7396
7744
8100
8464
8836
9216
9604
10000
</code></pre>

<p>So what does this do? The i variable is assined to 0, then 1, and so on. All the way up to 100 by 2.</p>

<h2>
<a id="looping-over-lines" class="anchor" href="#looping-over-lines" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Looping Over Lines</h2>

<div class="highlight highlight-source-shell"><pre>curl -s <span class="pl-s"><span class="pl-pds">"</span>http://api.randomuser.me/?results=5<span class="pl-pds">"</span></span> <span class="pl-k">&gt;</span> users.json</pre></div>

<div class="highlight highlight-source-shell"><pre>tail users.json</pre></div>

<pre><code>                    "medium": "https://randomuser.me/api/portraits/med/men/55.jpg",
                    "thumbnail": "https://randomuser.me/api/portraits/thumb/men/55.jpg"
                }
            }
        }
    ],
    "nationality": "NZ",
    "seed": "5e9d1ae85f789a080c",
    "version": "0.8"
}
</code></pre>

<div class="highlight highlight-source-shell"><pre>jq -r <span class="pl-s"><span class="pl-pds">'</span>.results[].user.email<span class="pl-pds">'</span></span> <span class="pl-k">&lt;</span> users.json <span class="pl-k">&gt;</span> emails.txt</pre></div>

<div class="highlight highlight-source-shell"><pre>tail emails.txt</pre></div>

<pre><code>cooper.thompson@example.com
elizabeth.green@example.com
matthew.anderson@example.com
matthew.hall@example.com
jack.martin@example.com
</code></pre>

<div class="highlight highlight-source-shell"><pre><span class="pl-c"># All of the above was to get data store it in json. Extract the emails</span>
<span class="pl-k">while</span> <span class="pl-c1">read</span> line
<span class="pl-k">do</span>
    <span class="pl-c1">echo</span> <span class="pl-s"><span class="pl-pds">"</span>Sending invitation to <span class="pl-smi">${line}</span>.<span class="pl-pds">"</span></span>
<span class="pl-k">done</span> <span class="pl-k">&lt;</span> emails.txt</pre></div>

<pre><code>Sending invitation to cooper.thompson@example.com.
Sending invitation to elizabeth.green@example.com.
Sending invitation to matthew.anderson@example.com.
Sending invitation to matthew.hall@example.com.
Sending invitation to jack.martin@example.com.
</code></pre>

<p>This is necessary because we don't know the number of e-mails ahead of time. </p>

<h2>
<a id="looping-over-files" class="anchor" href="#looping-over-files" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Looping over files</h2>

<p>This is probably one of the most common ways to use for loops:</p>

<div class="highlight highlight-source-shell"><pre><span class="pl-k">for</span> <span class="pl-smi">filename</span> <span class="pl-k">in</span> <span class="pl-k">*</span>.gz
<span class="pl-k">do</span>
    <span class="pl-c1">echo</span> <span class="pl-s"><span class="pl-pds">"</span>Processing <span class="pl-smi">${filename}</span>.<span class="pl-pds">"</span></span>
<span class="pl-k">done</span>
</pre></div>

<pre><code>Processing 10.json.gz.
Processing 1.json.gz.
Processing 2.json.gz.
Processing 3.json.gz.
Processing 4.json.gz.
Processing 5.json.gz.
Processing 6.json.gz.
Processing 7.json.gz.
Processing 8.json.gz.
Processing 9.json.gz.
</code></pre>

<p>Another useful tool that comes in handy and can do looping is the find tool</p>

<div class="highlight highlight-source-shell"><pre>find <span class="pl-c1">.</span> -name <span class="pl-s"><span class="pl-pds">"</span>*.gz<span class="pl-pds">"</span></span> -exec <span class="pl-c1">echo</span> <span class="pl-s"><span class="pl-pds">"</span>Processing {}<span class="pl-pds">"</span></span> <span class="pl-cce">\;</span></pre></div>

<pre><code>Processing ./4.json.gz
Processing ./5.json.gz
Processing ./6.json.gz
Processing ./9.json.gz
Processing ./3.json.gz
Processing ./7.json.gz
Processing ./10.json.gz
Processing ./8.json.gz
Processing ./2.json.gz
Processing ./1.json.gz
</code></pre>

<h2>
<a id="but-technically" class="anchor" href="#but-technically" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>But technically</h2>

<p>Technically this doesn't process anything in parallel. It just does it sequentially. This can be really useful, but it is different than in parallel.</p>

<p>One way to run things in parallel is to start them with the &amp; at the end of the line. This runs them in the background. But this is a little shallow when it comes to features.</p>

<p>The command we need is actually called parallel!</p>

<div class="highlight highlight-source-shell"><pre>seq 5 <span class="pl-k">|</span> parallel <span class="pl-s"><span class="pl-pds">"</span>echo {}^2<span class="pl-pds">"</span></span></pre></div>

<pre><code>1^2
2^2
3^2
4^2
5^2
</code></pre>

<p>There are all kinds of parallel command arguments, but I'll mention a few of my favorites.</p>

<div class="highlight highlight-source-shell"><pre>seq 20 <span class="pl-k">|</span> parallel -j 10 --joblog /tmp/echo.log <span class="pl-s"><span class="pl-pds">"</span>echo {}^2<span class="pl-pds">"</span></span></pre></div>

<pre><code>1^2
2^2
3^2
4^2
5^2
6^2
7^2
8^2
9^2
10^2
11^2
12^2
13^2
14^2
15^2
16^2
17^2
18^2
19^2
20^2
</code></pre>

<div class="highlight highlight-source-shell"><pre>head /tmp/echo.log</pre></div>

<pre><code>Seq Host    Starttime   Runtime Send    Receive Exitval Signal  Command
1   :   1456797251.903  0.067   0   0   0   0   echo 1^2
2   :   1456797251.911  0.069   0   0   0   0   echo 2^2
3   :   1456797251.918  0.071   0   0   0   0   echo 3^2
4   :   1456797251.926  0.070   0   0   0   0   echo 4^2
5   :   1456797251.933  0.074   0   0   0   0   echo 5^2
6   :   1456797251.939  0.078   0   0   0   0   echo 6^2
7   :   1456797251.946  0.079   0   0   0   0   echo 7^2
8   :   1456797251.953  0.080   0   0   0   0   echo 8^2
9   :   1456797251.963  0.079   0   0   0   0   echo 9^2
</code></pre>

<p>The -j 10 is the specify to run 10 jobs in parallel. There are a lot of different options available for parallel, but these are my most common ones. I also sometimes specify a results directory, which is where we can put output.</p>

<div class="highlight highlight-source-shell"><pre>mkdir outputs
seq 20 <span class="pl-k">|</span> parallel --results outputs -j 10 --joblog /tmp/echo.log <span class="pl-s"><span class="pl-pds">"</span>echo {}^2<span class="pl-pds">"</span></span></pre></div>

<pre><code>1^2
2^2
3^2
4^2
5^2
6^2
7^2
8^2
9^2
10^2
11^2
12^2
13^2
14^2
15^2
16^2
17^2
18^2
19^2
20^2
</code></pre>

<div class="highlight highlight-source-shell"><pre>ls outputs/1/<span class="pl-k">*</span></pre></div>

<pre><code>outputs/1/1:
stderr  stdout

outputs/1/10:
stderr  stdout

outputs/1/11:
stderr  stdout

outputs/1/12:
stderr  stdout

outputs/1/13:
stderr  stdout

outputs/1/14:
stderr  stdout

outputs/1/15:
stderr  stdout

outputs/1/16:
stderr  stdout

outputs/1/17:
stderr  stdout

outputs/1/18:
stderr  stdout

outputs/1/19:
stderr  stdout

outputs/1/2:
stderr  stdout

outputs/1/20:
stderr  stdout

outputs/1/3:
stderr  stdout

outputs/1/4:
stderr  stdout

outputs/1/5:
stderr  stdout

outputs/1/6:
stderr  stdout

outputs/1/7:
stderr  stdout

outputs/1/8:
stderr  stdout

outputs/1/9:
stderr  stdout
</code></pre>

<p>You can also have input with multiple pieces and use {1} and {2}.</p>

<div class="highlight highlight-source-shell"><pre>ls -l <span class="pl-k">|</span> parallel -C<span class="pl-s"><span class="pl-pds">"</span> <span class="pl-pds">"</span></span> <span class="pl-c1">echo</span> <span class="pl-s"><span class="pl-pds">"</span>{} One: {1} Two: {2} Three: {3}<span class="pl-pds">"</span></span></pre></div>

<pre><code>total 128 One: total Two: 128 Three: {3}
-rw-rw-r-- 1 learn2mine learn2mine 10817 Feb 15 21:46 10.json.gz One: -rw-rw-r-- Two: 1 Three: learn2mine
-rw-rw-r-- 1 learn2mine learn2mine 7410 Feb 15 21:46 1.json.gz One: -rw-rw-r-- Two: 1 Three: learn2mine
-rw-rw-r-- 1 learn2mine learn2mine 7707 Feb 15 21:46 2.json.gz One: -rw-rw-r-- Two: 1 Three: learn2mine
-rw-rw-r-- 1 learn2mine learn2mine 6863 Feb 15 21:46 3.json.gz One: -rw-rw-r-- Two: 1 Three: learn2mine
-rw-rw-r-- 1 learn2mine learn2mine 8451 Feb 15 21:46 4.json.gz One: -rw-rw-r-- Two: 1 Three: learn2mine
-rw-rw-r-- 1 learn2mine learn2mine 9013 Feb 15 21:46 5.json.gz One: -rw-rw-r-- Two: 1 Three: learn2mine
-rw-rw-r-- 1 learn2mine learn2mine 8377 Feb 15 21:46 6.json.gz One: -rw-rw-r-- Two: 1 Three: learn2mine
-rw-rw-r-- 1 learn2mine learn2mine 7229 Feb 15 21:46 7.json.gz One: -rw-rw-r-- Two: 1 Three: learn2mine
-rw-rw-r-- 1 learn2mine learn2mine 11022 Feb 15 21:46 8.json.gz One: -rw-rw-r-- Two: 1 Three: learn2mine
-rw-rw-r-- 1 learn2mine learn2mine 10256 Feb 15 21:46 9.json.gz One: -rw-rw-r-- Two: 1 Three: learn2mine
-rw-rw-r-- 1 learn2mine learn2mine 134 Feb 29 20:28 emails.txt One: -rw-rw-r-- Two: 1 Three: learn2mine
lrwxrwxrwx 1 learn2mine learn2mine 22 Feb 15 21:46 movies.txt -&gt; ../../.data/movies.txt One: lrwxrwxrwx Two: 1 Three: learn2mine
drwxrwxr-x 3 learn2mine learn2mine 4096 Feb 29 20:56 outputs One: drwxrwxr-x Two: 3 Three: learn2mine
-rw-rw-r-- 1 learn2mine learn2mine 12998 Feb 29 20:59 Parallel Processing.ipynb One: -rw-rw-r-- Two: 1 Three: learn2mine
lrwxrwxrwx 1 learn2mine learn2mine 22 Feb 15 21:46 users.json -&gt; ../../.data/users.json One: lrwxrwxrwx Two: 1 Three: learn2mine
</code></pre>

<p>What if we also need to get use part of the input? A common thing is to want on the name of a file. For example:</p>

<div class="highlight highlight-source-shell"><pre>ls /home/learn2mine/<span class="pl-k">*</span>.py <span class="pl-k">|</span> parallel <span class="pl-s"><span class="pl-pds">"</span>echo {}<span class="pl-pds">"</span></span></pre></div>

<pre><code>/home/learn2mine/change_passwords.py
/home/learn2mine/create_users.py
</code></pre>

<div class="highlight highlight-source-shell"><pre>ls /home/learn2mine/<span class="pl-k">*</span>.py <span class="pl-k">|</span> parallel <span class="pl-s"><span class="pl-pds">"</span>echo {/}<span class="pl-pds">"</span></span></pre></div>

<pre><code>change_passwords.py
create_users.py
</code></pre>

<p>Tip: If you ever want to do a check before running things. I definitely recommend this btw. Use --dryrun.</p>

<div class="highlight highlight-source-shell"><pre>ls /home/learn2mine/<span class="pl-k">*</span>.py <span class="pl-k">|</span> parallel --dryrun <span class="pl-s"><span class="pl-pds">"</span>echo {/}<span class="pl-pds">"</span></span></pre></div>

<pre><code>echo change_passwords.py
echo create_users.py
</code></pre>

<h2>
<a id="executing-on-remote-machines" class="anchor" href="#executing-on-remote-machines" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Executing on remote machines</h2>

<p>--nonall instructs parallel to execute same command on every remote machine in instances file. Since we aren't going to setup multiple machines at this time, we will use --sshlong : which says to use the local machine.</p>

<div class="highlight highlight-source-shell"><pre>parallel --nonall --sshlogin <span class="pl-c1">:</span> hostname</pre></div>

<pre><code>learn2mine-server
</code></pre>

<p>We won't spend too much time on this part of the chapter at this time. More often than not a real distributed system will use a batch processing system (e.g., pbs or slurm or hadoop).</p>

<div class="highlight highlight-source-shell"><pre></pre></div>
      </section>
      <footer>
        <p>Project maintained by <a href="https://github.com/Anderson-Lab">Anderson-Lab</a></p>
        <p><small>Hosted on GitHub Pages &mdash; Theme by <a href="https://twitter.com/michigangraham">mattgraham</a></small></p>
      </footer>
    </div>
    <!--[if !IE]><script>fixScale(document);</script><![endif]-->
    
  </body>
</html>
